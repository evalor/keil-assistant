# 当前上下文

*最后更新: 2025-12-21*

## 当前工作焦点

### 即将进行的功能增强

用户计划对插件进行功能增强。Memory Bank已完成重新初始化，准备好记录接下来的开发工作。

### 最近变化

**v2.2.1 (2025-12-10) 主要更新**：

1. **智能C/C++配置管理**
   - 项目标签支持，配置名称使用"项目名_目标名"格式
   - 避免多项目配置冲突
   - 自动配置切换和迁移

2. **C251完整支持**
   - 新增C251Target类
   - 自动检测C251项目类型
   - 完整编译和下载功能

3. **系统头文件检测重大优化**
   - 全新智能检测算法
   - 支持Keil V5/V6多种安装场景
   - 多重fallback机制
   - 详细调试日志

4. **WSL环境检测**
   - 明确检测WSL会话
   - 友好的错误提示

5. **任务执行优化**
   - 使用ProcessExecution替代ShellExecution
   - 提升可靠性和性能

## 活跃决策

### 架构决策

1. **项目存储位置改变**
   - 从`.vscode/`迁移到`globalStorage/{prjID}/`
   - 原因：保持工作区整洁，支持多项目隔离
   - 影响：日志和临时文件不再污染工作区

2. **配置命名规则**
   - 采用"项目名_目标名"格式
   - 原因：避免多项目Target名称冲突
   - 影响：自动迁移旧配置，向后兼容

3. **路径检测策略**
   - 多重fallback机制
   - 详细日志记录每个检测步骤
   - 原因：兼容各种Keil安装场景
   - 影响：提高配置成功率

### 技术选择

1. **ProcessExecution vs ShellExecution**
   - 决策：使用ProcessExecution
   - 原因：
     - 避免Shell转义问题
     - 更可靠的参数传递
     - 兼容VSCode 1.103+
   - 权衡：需要手动处理参数数组

2. **异步操作**
   - 决策：配置应用改为async/await
   - 原因：避免界面阻塞
   - 影响：改进用户体验

## 下一步计划

### 待定功能
- 等待用户明确功能增强需求
- 准备好支持新功能开发
- Memory Bank已就绪

### 技术债务优先级（预期）
1. **高优先级**
   - 拆分extension.ts大文件
   - 添加单元测试
   - 性能优化（大型项目）

2. **中优先级**
   - 改进错误提示
   - 增强配置向导
   - 文档完善

3. **低优先级**
   - UI主题定制
   - 更多快捷键
   - 插件设置面板

## 当前挑战

### 技术挑战

1. **大型项目性能**
   - 问题：包含大量文件的项目加载慢
   - 影响：用户体验下降
   - 待解决：考虑增量加载或缓存机制

2. **路径处理复杂性**
   - 问题：各种路径格式（相对/绝对/带空格/..符号）
   - 当前方案：规范化处理 + 多重验证
   - 改进空间：更智能的路径解析

3. **错误诊断准确性**
   - 问题：复杂编译错误的路径解析
   - 当前方案：正则表达式匹配 + 路径规范化
   - 改进空间：支持更多错误格式

### 用户反馈关注点

1. **配置简化**
   - 首次使用需要配置UV4路径
   - 考虑：自动检测Keil安装位置

2. **多项目管理**
   - 当前：支持多项目但切换需手动
   - 考虑：项目切换快捷键或状态栏选择器

3. **编译速度**
   - 已实现：多核并行编译
   - 进一步：缓存未变更文件，智能增量编译

## 重要约束

### 必须遵守的约束

1. **平台约束**
   - 仅支持Windows
   - WSL环境需检测并提示

2. **依赖约束**
   - 需要Keil uVision 5+
   - 推荐安装C/C++扩展

3. **性能约束**
   - 防抖机制：2秒
   - 消息去重：2秒
   - 操作响应：< 2秒

4. **兼容性约束**
   - 支持Keil V5完整/不完整安装
   - 支持Keil V6目录结构
   - 向后兼容旧配置格式

### 设计原则

1. **零配置优先**
   - 自动检测项目
   - 自动生成配置
   - 智能选择默认值

2. **用户友好**
   - 清晰的错误消息
   - 详细的解决建议
   - 及时的状态反馈

3. **性能优先**
   - 多核并行编译
   - 防抖和去重
   - 异步操作不阻塞

4. **可维护性**
   - 详细日志记录
   - 模块化设计
   - 类型安全

## 开发环境状态

### 当前分支
- **主分支**: master
- **状态**: 稳定，v2.2.1已发布

### 构建状态
- ✅ 编译通过
- ✅ 打包成功
- ✅ 基本功能验证通过

### 依赖状态
- ✅ 所有依赖已安装
- ✅ 无已知安全漏洞
- ℹ️ 使用Webpack 5打包

## 协作上下文

### 团队结构
- **维护者**: Rui Wang (ruiwarn)
- **发布者**: candycium
- **社区**: GitHub Issues + 微信支持

### 沟通渠道
- GitHub Issues: 问题跟踪
- GitHub Discussions: 功能讨论
- 微信: 18219255930 (直接支持)

### 发布流程
1. 开发并测试新功能
2. 更新CHANGELOG.md
3. 提交并推送到GitHub
4. 创建发布标签
5. 使用vsce打包
6. 发布到VS Code Marketplace

## 已知问题

### 当前开放问题

1. **路径处理边缘情况**
   - 某些特殊字符路径可能解析失败
   - 网络驱动器路径性能差
   - 待优化：路径规范化逻辑

2. **大型项目性能**
   - 超过1000个文件的项目加载慢
   - XML解析耗时
   - 待优化：增量加载机制

3. **文档完善度**
   - 需要更多示例和教程
   - API文档需要补充
   - 贡献指南待完善

### 临时解决方案

1. **路径问题**
   - 建议：使用英文路径
   - 建议：避免特殊字符
   - 建议：使用本地驱动器

2. **性能问题**
   - 建议：关闭不需要的项目
   - 建议：使用排除列表
   - 建议：升级硬件（SSD）

## 学习和改进

### 最近学到的经验

1. **路径检测的重要性**
   - 不同Keil安装配置差异很大
   - 需要多重fallback保证成功
   - 详细日志对诊断至关重要

2. **配置命名冲突**
   - 多项目使用相同Target名时会冲突
   - "项目名_目标名"格式解决问题
   - 自动迁移保证兼容性

3. **异步操作的必要性**
   - 同步操作会阻塞UI
   - 配置应用需要异步
   - 用户体验显著改善

### 待探索领域

1. **增量编译**
   - 研究UV4是否支持
   - 如何检测文件变化
   - 如何缓存编译结果

2. **调试支持**
   - 是否可以集成调试器
   - OpenOCD集成可能性
   - J-Link/ST-Link支持

3. **云端协作**
   - 配置共享机制
   - 项目模板库
   - 社区代码片段

## 关键度量

### 当前指标（估计）

1. **功能完整性**
   - 项目加载: 95%+
   - 编译功能: 98%+
   - 配置生成: 90%+
   - 错误诊断: 85%+

2. **性能指标**
   - 项目加载: < 3秒（小型项目）
   - 编译速度: 提升200-300%
   - 配置更新: < 1秒

3. **用户满意度**
   - GitHub星标: 持续增长
   - Issue解决: 活跃响应
   - 用户反馈: 积极正面

### 改进目标

1. **短期目标**
   - 项目加载 < 2秒
   - 配置生成准确率 > 95%
   - 添加单元测试覆盖

2. **中期目标**
   - 支持调试功能
   - 建立模板库
   - 完善文档

3. **长期目标**
   - 成为首选Keil扩展
   - 建立活跃社区
   - 扩展工具链支持

---

## 注意事项

📌 **重要**: Memory Bank已完成重新初始化，所有核心文件已更新。准备好开始记录即将到来的功能增强工作。

🔄 **更新频率**: 每次重大功能开发时更新此文件。记录决策、进展和学习。

💡 **使用建议**: 
- 开始新任务前阅读此文件
- 完成任务后更新相关部分
- 记录重要决策和原因
- 保持内容简洁相关
